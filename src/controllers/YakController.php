<?php
namespace kordar\yak\controllers;

use kordar\yak\behaviors\RbacFilter;
use kordar\yak\helpers\YakConfigHelper;
use kordar\yak\helpers\LoggerHelper;
use yii\filters\VerbFilter;

class YakController extends \yii\web\Controller
{
    /**
     * @var string
     */
    protected $template = '';

    /**
     * @var array
     */
    protected $rbacExcept = [];

    /**
     * @var array
     */
    protected $rbacJsonMessageOnly = [];

    /**
     * @var array
     */
    protected $verbs = [
        'delete' => ['POST']
    ];

    public function init()
    {
        $this->template = YakConfigHelper::config('yak.template', 'ace');
        $this->template = strtolower($this->template);
        $GLOBALS['yak_sign'] = $this->template;
        $this->layout = '@kordar/yak/_' . $this->template . '/layout/main.php';
    }

    public function renderTpl($view, $params = [])
    {
        // TODO: Change the autogenerated stub
        return parent::render('@kordar/yak/_' . $this->template . '/views/' . $this->id . '/' . $view, $params);
    }

    public function behaviors()
    {
        return [
            'verbs' => [
                'class' => VerbFilter::className(),
                'actions' => $this->verbs,
            ],
            'rbac' => [
                'class' => RbacFilter::className(),
                'except' => $this->rbacExcept,
                'jsonMessageOnly' => $this->rbacJsonMessageOnly
            ]
        ];
    }

    protected $closeCsrfValidate = ['upload'];

    public function beforeAction($action)
    {
        if(in_array($action->id, $this->closeCsrfValidate)) {
            $action->controller->enableCsrfValidation = false;
        }
        return parent::beforeAction($action);
    }

    protected function writeLogger()
    {
        return [];
    }

    public function afterAction($action, $result)
    {
        $logger = $this->writeLogger();
        if (key_exists($action->id, $logger)) {
            LoggerHelper::writeLogger($logger[$action->id]);
        }

        return parent::afterAction($action, $result); // TODO: Change the autogenerated stub
    }


}